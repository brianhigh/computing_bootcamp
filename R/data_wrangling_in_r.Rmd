---
title: "Data Wrangling in R"
author: "Brian High"
date: "![CC BY-SA 4.0](../images/cc_by-sa_4.png)"
output:
  ioslides_presentation:
    fig_caption: yes
    fig_retina: 1
    fig_width: 5
    fig_height: 4
    keep_md: yes
    smaller: yes
    logo: ../images/logo_128.png
---

```{r set_knitr_options, echo=FALSE, message=FALSE}
suppressMessages(library(knitr))
opts_chunk$set(tidy=FALSE, cache=FALSE, echo=TRUE, message=FALSE)
```

```{r load_packages, echo=FALSE}
# Load one or more packages into memory, installing as needed.
# https://github.com/brianhigh/imp ; License: Public Domain (CC0 1.0)
load.pkgs <- function(pkgs, repos = 'http://cran.r-project.org') {
  is.installed <- function(x) x %in% installed.packages()[,"Package"]
  inst.cran <- function(x) install.packages(x, quiet = TRUE, repos = repos)
  result <- sapply(pkgs, function(x) { 
    if (! is.installed(x)) inst.cran(x)
    library(x, character.only = TRUE)
  })
}

pkgs <- c("dplyr", "ggplot2", "tidyr", "WDI", "WHO", "grid", "gridExtra", "pacman")
load.pkgs(pkgs)

p_load_gh("hadley/ggplot2@2.1.0.9000", install = TRUE)  # To support subtitles
```

## Learning Objectives

You will learn:

* What data "wrangling" and "munging" are and why you should care
* What "tidy data" is and how to achieve it
* Packages and functions used to tidy and wrangle data in R
* How to tidy and wrangle data with R
* How to create and customize plots with `qplot` and `ggplot`

## What is "data wrangling"?

[data wrangling](https://en.wikipedia.org/wiki/Data_wrangling) is:

> Transforming "raw" data into a more useful format through clever methods.

[Webster's Dictionary](http://www.merriam-webster.com/dictionary/wrangle) defines 
"wrangle" as:

* to argue angrily with someone
* to get (something) by **_clever methods_** or by persuading someone
* to **_control and care for_** (horses, cattle, etc.) on a ranch

Other (related) terms, which may form a part of the wrangling process:

* Data "munging" (like "wrangling" but more hackish)
* Data cleaning
* Data conversion
* Data reshaping
* Data formatting
* Data tidying

## Data "wrangling" and "munging"

The [ETL](https://en.wikipedia.org/wiki/Extract,_transform,_load) **transform** 
step is commonly referred to [data wrangling](https://en.wikipedia.org/wiki/Data_wrangling) or [munging](https://en.wikipedia.org/wiki/Mung_(computer_term)) in the data analysis 
world. 

Here is a short list of some of the more popular data wrangling (or munging) functions in R.

| Package | Functions
| ------- | ---------
| base    | names, subset, merge, match, gsub, unique, sort
| stats   | aggregate, reshape, na.omit
| dplyr   | select, filter, group_by, summarize, arrange, join, mutate
| tidyr   | gather, separate, unite, spread

*Data munging is one of [the three sexy skills of data geeks](http://medriscoll.com/post/4740157098/the-three-sexy-skills-of-data-geeks). -- @medriscoll*

## Quick Example: Iris Dataset

We can do data wrangling and plotting in a single command. First let's look at a 
dataset.

```{r}
library(datasets)
data(iris)
str(iris)
```

## Quick Example: Pipe to `ggplot`

We can "pipe" data directly to `ggplot`.

```{r no-facets-1}
library(dplyr); library(ggplot2)
iris %>% ggplot(., aes(x=Petal.Width, y=Petal.Length, color=Species)) + geom_point()
```

## Quick Example: Mutation on the Fly

Therefore, we can also pipe to `mutate` and then to `ggplot`.

```{r no-facets-2}
iris %>% mutate(ratio.sep = Sepal.Width/Sepal.Length) %>%
         ggplot(., aes(x=Petal.Width, y=ratio.sep, color=Species)) + geom_point()
```

## Tidy Data

*[data tidying](https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html): structuring datasets to facilitate analysis -- @hadleywickham*

According to [Hadley Wickham](https://github.com/hadley), tidy data:

* Each variable forms a column.
* Each observation forms a row.
* Each type of observational unit forms a table.

So far, our datasets have all come with this basic structure.

Let's look at some "untidy" data...

## Untidy Data: Aaargh!!

![](images/spreadsheet.jpg)

## Tidying data

[Hadley Wickham](https://github.com/hadley), creator of the *ggplot2*, *dplyr*, 
and many other popular packages, has also given us the [tidyr](https://cran.r-project.org/web/packages/tidyr/index.html) package.

From `library(help="tidyr")`, we will find some of the most important functions
in this package:

| Function    | Description
| ----------- | -----------
| gather      | Gather columns into key-value pairs.
| spread      | Spread a key-value pair across multiple columns.
| extract     | Extract one column into multiple columns.
| separate    | Separate one column into multiple columns.
| unite       | Unite multiple columns into one.

Let's see some of these in action with an example...

## Tidy Data Example: Iris

The `iris` dataset that comes with R has a strange structure.

```{r}
library(datasets)
data("iris")
str(iris)
```

See how the columns are named? What tidy data requirement has been violated?

* Each variable forms a column.
* Each observation forms a row.
* Each type of observational unit forms a table.

## qplot: Plot with facets

```{r facet-1}
qplot(x=Sepal.Width, y=Sepal.Length, data=iris, geom=c("point"),
      color=Species, facets=Species~.)
```

## Iris Data Wrangling

How would we facet on flower part **and** `Species` (in a single plot)?

A column names like `Sepal.Length` and `Sepal.Width` store a flower part (Sepal)
with a measurement (Length and Width). This is an example of a "wide" format.

This naming violates the principle of "each variable forms a column", since a 
flower part and a dimension measurement are two different variables. 
It matters because we also have `Petal.Length` and `Petal.Width`.

We want a structure which separates the measument type information from the 
flower part information. 

This will give us a column for flower part which we can use for our plot facets.
This will be a longer (narrower) table structure with more rows. 

We will double the number of rows from 150 to 300 -- for 150 individual flowers.

## dplyr: `mutate`

Using `mutate`, add a column to keep track of the flower id (`iris_id`.)

```{r}
iris_id <- mutate(iris, flower_id = rownames(iris))
head(iris_id)
```

## tidyr: `gather`

Convert wide data format to long format.

```{r}
library(tidyr)
iris_gathered <- gather(iris_id, variable, value, c(-Species, -flower_id))
head(iris_gathered)
```

## tidyr: `extract`

Remove the `variable` column and add new columns for the parsed values. 

```{r}
iris_parsed <- extract(iris_gathered, variable, 
                       c("flower_part", "measurement_type"), "(.+)\\.(.+)")
head(iris_parsed)
```

The string `"(.+)\\.(.+)"` is a 
[regular expression](https://en.wikipedia.org/wiki/Regular_expression) 
that uses [grouping](https://regexone.com/lesson/capturing_groups) to parse the 
text into groups which `extract` uses to fill the new `flower_part` and 
`measurement_type` variables.

## tidyr: `spread`

Go back to a wider format. Convert `measurement_type` and `value` to columns
named `Length` and `Width`.

```{r}
iris_spread <- spread(iris_parsed, measurement_type, value)
head(iris_spread)
```

This is now a tidy dataset because each each variable forms a column
and no column (name) contains any other kind of information. Now  we can facet
on both `flower_part` **_and_** `Species`.

## qplot: Plot with more facets

```{r facet-2}
qplot(x=Width, y=Length, data=iris_spread, geom=c("point"), size=I(0.3),
      color=Species, facets=flower_part~Species)
```

## ggplot: Plot with more facets

```{r facet-3}
ggplot(data=iris_spread, aes(x=Width, y=Length)) + 
    geom_point(size=I(0.5)) + facet_grid(Species~flower_part, scale="free") +
    geom_smooth(method="lm") + theme_bw(base_size=16)
```

## Example: Wrangling Malaria Cases

Search the World Bank database using the *WDI* package to find cases of 
[Malaria](http://worldbank.270a.info/classification/indicator/SH.STA.MALR.html) 
in Central America (and Mexico) and plot the count of cases by country and year.

```{r, message=FALSE}
library(WDI)
WDIsearch("malaria cases")                # Search by (partial) report name
Malaria <- WDI(indicator='SH.STA.MALR')   # Fetch dataset by indicator
str(Malaria)                              # Show the structure of the dataset
```

NOTE: The default year range for a `WDI()` query is: 2005 - 2011.

## Wrangling Country Codes and Regions

What countries are in Central America? Our dataset does not show region 
or subregion. We need a dataset that shows country, region, and subregion.

A search for various terms in `WDI` does not turn up the list we need. 
Get this list elsewhere. Perhaps there is a list of ISO country codes?
There is a *ISOcodes* package, but its `ISO_3166_2` dataset does not include 
the sub-region names.

An ISO country code 
[CSV](https://github.com/lukes/ISO-3166-Countries-with-Regional-Codes/blob/master/all/all.csv), with subregion names, was found by a Google [search](https://www.google.com/search?q=iso+3166+sub-region+filetype%3Acsv).

```{r}
data.folder <- 'data'
dir.create(data.folder, showWarnings = FALSE)   # Create data folder if needed

iso2c.file <- file.path(data.folder, 'iso2c.csv')

# Only download the file if it does not already exist
if (! file.exists(iso2c.file)) {
    # Split URL into several variables so the line doesn't wrap :p
    site <- 'https://raw.githubusercontent.com'
    repo <- 'lukes/ISO-3166-Countries-with-Regional-Codes'
    file <- 'master/all/all.csv'
    method <- ifelse(.Platform$OS.type == 'windows', 'wininet', 'curl')
    download.file(paste(site, repo, file, sep='/'), iso2c.file, method)
}
```

## Wrangling Country Codes and Regions

Import the CSV file and then clean up the data using the *dplyr* package:

* read the CSV file with `read.csv`
* filter for Central American countries with `filter`
* select the only the two columns we need with `select`

```{r}
codes <- read.csv(iso2c.file, header=TRUE, stringsAsFactors = FALSE)
codesCA <- codes %>% filter(sub.region == 'Central America') %>% 
    select(c(name, iso2c = alpha.2))
codesCA
```

## Wrangling Malaria Cases

Using the *dplyr* package (and a few others), clean up the data:

* "Pipe" data between operations using `%>%` (from the *magrittr* package)
* rename columns with the `rename` function
* remove NAs with the `na.omit` function (from the *stats* package)
* filter by country with `filter` using the `%in%` (match) operator
* sort country name and year with `arrange`
* `select` just the columns we need (country, year, cases)

```{r, message=FALSE}
MalWDI <- Malaria %>% rename(cases = SH.STA.MALR) %>% na.omit() %>% 
          filter(country %in% codesCA$name) %>% arrange(country, year) %>%
          select(country, year, cases)
head(MalWDI, 4)
```

## Plotting Malaria Cases by Year

Make a stacked-bar plot of Malaria cases by year and colored by country.

```{r}
pltWDI <- ggplot(MalWDI, aes(x=year, y=cases, fill=country)) + 
          geom_bar(stat="identity") + labs(x = "year", y = "cases", 
          title = "Malaria Cases in Central America\nby Year (Source: WDI)")
```

## Plotting Malaria Cases by Year

```{r malaria-ggplot}
pltWDI
```

## Compare Data Sources: WHO and WDI

We can [search](https://www.google.com/search?q=who+"WHS3_48") the 
database of the World Health Organization (WHO) and we can find the same 
[dataset](http://apps.who.int/gho/data/view.main.14110). It is titled, 
"Reported confirmed cases (Microscopy slides/RDTs positive) Data by country" 
on the WHO website. 

Let's fetch and wrangle this dataset for comparison.

```{r}
#install.packages("WHO")
library(WHO)
codes <- get_codes()

code <- filter(codes, display == 'Malaria - number of reported confirmed cases')
df <- get_data(code$label)

MalWHO <- df %>% 
          filter(country %in% codesCA$name, year %in% 2005:2011) %>%
          mutate(cases = as.integer(gsub(" ", "", value, fixed=TRUE))) %>%
          group_by(country, year) %>% summarise(cases = sum(cases)) %>%
          arrange(country, year)

# Are the two datasets (WDI and WHO) equal?
all.equal(MalWDI, MalWHO, check.attributes=FALSE)
```

## Compare Data Sources: WHO and WDI

Make a stacked-bar plot of Malaria cases by year and colored by country.

```{r}
pltWHO <- ggplot(aes(x=year, y=cases, fill=country), data = MalWHO) + 
          geom_bar(stat="identity") + labs(x = "year", y = "cases", 
          title = "Malaria Cases in Central America\nby Year (Source: WHO)")
```

## Compare Data Sources: WHO and WDI

```{r malaria-who-stacked-bar, fig.height=4, fig.width=8}
library(grid); library(gridExtra)
grid.arrange(pltWDI, pltWHO, ncol=2)
```

## Example: Malaria Prevalence

Let's calculate the Malaria prevalence as the count of Malaria cases per 100,000
people for each of the countries of Central America and Mexico. We will need
to know the total 
[population](http://worldbank.270a.info/classification/indicator/SP.POP.TOTL.html) 
for each contry for each year.

```{r}
WDIsearch("population, total")          # Search database for indicator
Pop <- WDI(indicator='SP.POP.TOTL')     # Fetch dataset by indicator
MalPop <- inner_join(Malaria, Pop, by = c("country", "iso2c", "year"))

MalCA <- MalPop %>% mutate(prev = 100000 * SH.STA.MALR/SP.POP.TOTL) %>%
    na.omit() %>% filter(iso2c %in% codesCA[,'iso2c']) %>% arrange(iso2c, year)
```

## Malaria Prevalence Bar Plot

```{r malaria-prevalance-ggplot-1}
ggplot(MalCA, aes(x=year, y=prev, fill=country)) + geom_bar(stat="identity") +
     ggtitle("Malaria Prevalence in Central America\nby Year (Source: World Bank)")
```

## Malaria Prevalence Wrangling

It looks like prevalence is decreasing exponentially over time. Calculate the
sum of the prevalences by year to get group totals, then log transform the totals.

```{r}
MalCASum <- MalCA %>% group_by(year) %>% summarize(prev=sum(prev)) %>% 
    mutate(logprev=log(prev))
MalCASum
```

## Malaria Prevalence Linear Model Fit

Check the fit of a linear model with the log prevalence as the response and 
year as the predictor.

```{r}
summary(lm(logprev ~ year, MalCASum))
```

## Malaria Prevalence Scatter Plot

Make a scatter plot of log prevalence per year with a linear regression line.

```{r, malaria-line-plot-pre-0, fig.height=3}
ggplot(MalCASum, aes(x = year, y = logprev)) + geom_point() + 
    geom_smooth(method="lm")
```

## Malaria Prevalence Line Plot

Let's make a line plot by country to show the trends for each country more clearly.

```{r, malaria-line-plot-pre-1, fig.height=3}
g <- ggplot(MalCA, aes(x = year, y = prev, color = country, linetype = country)) + 
     geom_line()
g
```

## Y-Axis Scale Log Transform

Log transform the y-axis to spread out the lines in lower end of the range.

```{r, malaria-line-plot-pre-2, fig.height=3}
g <- g + scale_y_continuous(trans = "log", breaks = c(1, 10, 100, 1000))
g
```

## Add Summarized Points and Smoother

Add the points and smooth line from the summarized dataframe. Hide the legend.

```{r malaria-line-plot-pre-2a, fig.height=3}
g <- g + geom_point(data = MalCASum, inherit.aes = FALSE, 
                    aes(x = year, y = prev, color = '')) +
    geom_smooth(data = MalCASum, method = 'lm', inherit.aes = FALSE, 
                aes(x = year, y = prev)) + theme(legend.position = "none")
g
```

## Add Title, Axis Labels, and Caption

Add a plot title, axis labels and a caption.

```{r, malaria-line-plot-pre-3, fig.height=3}
g <- g + ggtitle("Malaria Prevalence in Central America", 
                 subtitle = paste('Reported confirmed cases per 100,000 people (',
                     min(MalCA$year), ' - ', max(MalCA$year), ')', sep = '')) + 
     labs(x = "Year", y = "log Prevalence",
          caption = "Source: World Development Indicators (WDI), World Bank")
g
```

## Define Custom Plot Theme

Define a custom theme to set the text options, margins, and remove the legend.

```{r}
text.color <- "#25383C"        # Dark Slate Grey

my.title <- element_text(hjust = 0.5, color=text.color)
my.text <- element_text(colour = text.color)
my.caption <- element_text(margin=margin(t=15), face = "italic", 
                           size = 8, hjust = 0.5, color=text.color)

my.theme <- theme(axis.title.x = my.title, axis.title.y = my.title,
                  axis.text.x = my.text, axis.text.y = my.text,
                  plot.title = my.title, plot.subtitle = my.title,
                  plot.margin = unit(c(.2, 4, .2, .2), "lines"), 
                  plot.caption = my.caption, legend.position = "none")
```

## Apply Theme and Set Color Hue

Apply the "minimal" theme, add the custom theme, and adjust the color hue for 
the plotted lines and their labels.

```{r, malaria-line-plot-pre-4, fig.height=3}
g <- g + theme_minimal() + my.theme + scale_color_hue(c=120, l=50)
g
```

## Add Line Labels

And add line labels to right of plot.

```{r}
g <- g + geom_text(data = subset(MalCA, year == max(MalCA$year)), hjust = 0,
               aes(label = country, colour = country, x = Inf, y = prev), size = 3) +
         geom_text(data = subset(MalCASum, year == max(MalCASum$year)), hjust = 0, 
               inherit.aes = FALSE, aes(label = "C. America", color = '', x = Inf, 
                                        y = prev), size = 4) 
```

To do this, we need to disable clipping to allow the labels to appear outside 
of the plot area. And for this, we need to create a grid graphical object ("grob").

```{r}
library(grid)
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name == "panel"] <- "off"
```

And now to display the the final plot ...

## Malaria Prevalence

```{r malaria-line-plot, fig.height=4.5}
grid.draw(gt)
```

## More Data Wrangling

If you have time and interest, you may continue with 
[more data wrangling](https://github.com/brianhigh/research-computing/blob/master/lab/Data_Wrangling.md), 
courtesy of Noah Simon and Ali Shojaie.

Or you might want to try the Swirl tutorials for [Getting and Cleaning Data](https://github.com/swirldev/swirl_courses/tree/master/Getting_and_Cleaning_Data). 

```{r, eval=FALSE}
library(swirl)
install_from_swirl("Getting and Cleaning Data")
swirl()
```
